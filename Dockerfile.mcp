# Build assets once, then run the Node MCP server

# 1) Builder: compila assets con pnpm
FROM node:20-alpine AS builder
WORKDIR /app
RUN corepack enable

# Archivos base del monorepo para que pnpm resuelva workspaces
COPY pnpm-workspace.yaml pnpm-lock.yaml package.json ./
COPY tsconfig*.json vite*.mts tailwind.config.ts build-all.mts dev-all.mts ./
COPY src ./src

RUN pnpm install --frozen-lockfile
RUN pnpm run build

# 2) Runtime: servidor MCP en Node
FROM node:20-alpine
WORKDIR /app
RUN corepack enable

# Copiamos archivos de workspace + paquete del server para que pnpm resuelva deps
COPY pnpm-workspace.yaml pnpm-lock.yaml package.json ./
# Copia el paquete completo (incluye src/)
COPY pizzaz_server_node/ /app/pizzaz_server_node/

# Instala dependencias incluyendo devDependencies (tsx necesario para ejecutar)
RUN cd pizzaz_server_node && pnpm install --no-frozen-lockfile

# Copia los assets ya construidos
COPY --from=builder /app/assets /app/assets

WORKDIR /app/pizzaz_server_node
ENV PORT=8000
EXPOSE 8000

# Usa el script start del paquete (que invoca tsx)
CMD ["pnpm","start"]
